<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日麻计分系统</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1, h2, h3 {
            color: #333;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        button.danger {
            background-color: #f44336;
        }
        button.danger:hover {
            background-color: #d32f2f;
        }
        button.secondary {
            background-color: #2196F3;
        }
        button.secondary:hover {
            background-color: #0b7dda;
        }
        input, select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #e0e0e0;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        .tab.active {
            background-color: #4CAF50;
            color: white;
        }
        .player-card {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #fff;
        }
        .player-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        .stat-box {
            background-color: #f8f8f8;
            padding: 10px;
            border-radius: 5px;
            min-width: 120px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        .highlight {
            font-weight: bold;
            color: #4CAF50;
        }
    </style>
</head>
<body>
    <div id="app">
        <h1>日麻计分系统</h1>
        
        <div class="tabs">
            <div class="tab" :class="{active: activeTab === 'current'}" @click="activeTab = 'current'">当前对局</div>
            <div class="tab" :class="{active: activeTab === 'history'}" @click="activeTab = 'history'">历史记录</div>
            <div class="tab" :class="{active: activeTab === 'players'}" @click="activeTab = 'players'">玩家管理</div>
        </div>
        
        <!-- 当前对局 -->
        <div class="container" v-if="activeTab === 'current'">
            <h2>当前对局</h2>
            
            <div>
                <h3>添加玩家</h3>
                <select v-model="newPlayerId">
                    <option v-for="player in availablePlayers" :value="player.id">{{ player.name }}</option>
                </select>
                <button @click="addPlayerToGame">添加</button>
            </div>
            
            <div v-if="currentGame.players.length > 0">
                <h3>玩家分数</h3>
                <table>
                    <thead>
                        <tr>
                            <th>玩家</th>
                            <th>分数</th>
                            <th>马点</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(player, index) in currentGame.players" :key="player.id">
                            <td>{{ getPlayerName(player.id) }}</td>
                            <td><input type="number" v-model.number="player.score" @change="calculateUma"></td>
                            <td>{{ player.uma }}</td>
                            <td><button class="danger" @click="removePlayerFromGame(index)">移除</button></td>
                        </tr>
                    </tbody>
                </table>
                
                <button @click="calculateRanking" :disabled="currentGame.players.length < 2">计算排名</button>
                
                <div v-if="currentGame.rankingCalculated">
                    <h3>排名结果</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>排名</th>
                                <th>玩家</th>
                                <th>分数</th>
                                <th>马点</th>
                                <th>顺位分</th>
                                <th>总得分</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(result, index) in currentGame.results" :key="result.playerId">
                                <td>{{ index + 1 }}</td>
                                <td>{{ getPlayerName(result.playerId) }}</td>
                                <td>{{ result.score }}</td>
                                <td>{{ result.uma }}</td>
                                <td>{{ result.positionPoint }}</td>
                                <td>{{ result.totalPoint }}</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <button @click="saveGame" :disabled="!currentGame.rankingCalculated">保存对局</button>
                </div>
            </div>
            <div v-else>
                <p>请添加至少2名玩家开始对局</p>
            </div>
        </div>
        
        <!-- 历史记录 -->
        <div class="container" v-if="activeTab === 'history'">
            <h2>历史对局记录</h2>
            
            <div v-if="selectedPlayerId">
                <h3>{{ getPlayerName(selectedPlayerId) }}的个人数据</h3>
                <div class="player-card">
                    <div class="player-stats">
                        <div class="stat-box">
                            <div class="stat-value">{{ getPlayerStats(selectedPlayerId).totalGames }}</div>
                            <div class="stat-label">总对局数</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">{{ getPlayerStats(selectedPlayerId).averageRank.toFixed(2) }}</div>
                            <div class="stat-label">平均顺位</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">{{ getPlayerStats(selectedPlayerId).totalUma }}</div>
                            <div class="stat-label">总马点</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">{{ getPlayerStats(selectedPlayerId).totalPoints }}</div>
                            <div class="stat-label">总得分</div>
                        </div>
                    </div>
                    
                    <h4>最近10场对局</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>日期</th>
                                <th>排名</th>
                                <th>马点</th>
                                <th>顺位分</th>
                                <th>总得分</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="game in getPlayerRecentGames(selectedPlayerId)" :key="game.id">
                                <td>{{ formatDate(game.date) }}</td>
                                <td>{{ getPlayerRankInGame(game, selectedPlayerId) }}</td>
                                <td>{{ getPlayerUmaInGame(game, selectedPlayerId) }}</td>
                                <td>{{ getPlayerPositionPointInGame(game, selectedPlayerId) }}</td>
                                <td>{{ getPlayerTotalPointInGame(game, selectedPlayerId) }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <button @click="selectedPlayerId = null">返回全部记录</button>
            </div>
            
            <div v-for="game in historyGames" :key="game.id">
                <h3>对局 {{ formatDate(game.date) }}</h3>
                <table>
                    <thead>
                        <tr>
                            <th>排名</th>
                            <th>玩家</th>
                            <th>分数</th>
                            <th>马点</th>
                            <th>顺位分</th>
                            <th>总得分</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="result in game.results" :key="result.playerId">
                            <td>{{ result.rank }}</td>
                            <td @click="selectPlayer(result.playerId)" class="highlight">{{ getPlayerName(result.playerId) }}</td>
                            <td>{{ result.score }}</td>
                            <td>{{ result.uma }}</td>
                            <td>{{ result.positionPoint }}</td>
                            <td>{{ result.totalPoint }}</td>
                            <td><button class="danger" @click="deleteGame(game.id)">删除</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- 玩家管理 -->
        <div class="container" v-if="activeTab === 'players'">
            <h2>玩家管理</h2>
            
            <div>
                <h3>添加新玩家</h3>
                <input type="text" v-model="newPlayerName" placeholder="玩家名称">
                <button @click="addPlayer">添加</button>
            </div>
            
            <h3>现有玩家</h3>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>名称</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="player in players" :key="player.id">
                        <td>{{ player.id }}</td>
                        <td>
                            <span v-if="!player.editing">{{ player.name }}</span>
                            <input v-if="player.editing" type="text" v-model="player.editName">
                        </td>
                        <td>
                            <button v-if="!player.editing" @click="startEditPlayer(player)">编辑</button>
                            <button v-if="player.editing" @click="saveEditPlayer(player)">保存</button>
                            <button v-if="player.editing" @click="cancelEditPlayer(player)">取消</button>
                            <button class="danger" @click="deletePlayer(player.id)" :disabled="isPlayerInGames(player.id)">删除</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        new Vue({
            el: '#app',
            data: {
                activeTab: 'current',
                players: [
                    { id: 1, name: '玩家1' },
                    { id: 2, name: '玩家2' },
                    { id: 3, name: '玩家3' },
                    { id: 4, name: '玩家4' }
                ],
                newPlayerName: '',
                newPlayerId: null,
                historyGames: [],
                selectedPlayerId: null,
                currentGame: {
                    players: [],
                    results: [],
                    rankingCalculated: false,
                    date: new Date()
                }
            },
            created() {
                this.loadData();
            },
            computed: {
                availablePlayers() {
                    // 返回未加入当前对局的玩家
                    const currentPlayerIds = this.currentGame.players.map(p => p.id);
                    return this.players.filter(player => !currentPlayerIds.includes(player.id));
                }
            },
            methods: {
                loadData() {
                    const savedPlayers = localStorage.getItem('mahjongPlayers');
                    const savedGames = localStorage.getItem('mahjongHistoryGames');
                    
                    if (savedPlayers) {
                        this.players = JSON.parse(savedPlayers);
                    }
                    
                    if (savedGames) {
                        this.historyGames = JSON.parse(savedGames);
                    }
                },
                saveData() {
                    localStorage.setItem('mahjongPlayers', JSON.stringify(this.players));
                    localStorage.setItem('mahjongHistoryGames', JSON.stringify(this.historyGames));
                },
                addPlayer() {
                    if (!this.newPlayerName.trim()) return;
                    
                    const newId = this.players.length > 0 ? Math.max(...this.players.map(p => p.id)) + 1 : 1;
                    this.players.push({
                        id: newId,
                        name: this.newPlayerName.trim()
                    });
                    
                    this.newPlayerName = '';
                    this.saveData();
                },
                startEditPlayer(player) {
                    player.editing = true;
                    player.editName = player.name;
                },
                saveEditPlayer(player) {
                    player.name = player.editName;
                    player.editing = false;
                    this.saveData();
                },
                cancelEditPlayer(player) {
                    player.editing = false;
                },
                deletePlayer(playerId) {
                    if (confirm('确定要删除这个玩家吗？')) {
                        this.players = this.players.filter(p => p.id !== playerId);
                        this.saveData();
                    }
                },
                isPlayerInGames(playerId) {
                    return this.historyGames.some(game => 
                        game.results.some(result => result.playerId === playerId)
                    );
                },
                addPlayerToGame() {
                    if (!this.newPlayerId) return;
                    
                    this.currentGame.players.push({
                        id: this.newPlayerId,
                        score: 25000,
                        uma: 0
                    });
                    
                    this.newPlayerId = null;
                    this.calculateUma();
                },
                removePlayerFromGame(index) {
                    this.currentGame.players.splice(index, 1);
                    this.currentGame.rankingCalculated = false;
                    this.calculateUma();
                },
                calculateUma() {
                    this.currentGame.players.forEach(player => {
                        player.uma = (player.score - 25000) / 1000;
                    });
                },
                calculateRanking() {
                    // 按分数排序
                    const sortedPlayers = [...this.currentGame.players].sort((a, b) => b.score - a.score);
                    
                    // 计算排名和顺位分
                    const results = [];
                    const positionPoints = [15, 5, -5, -15];
                    
                    let currentRank = 1;
                    while (currentRank <= sortedPlayers.length) {
                        // 查找所有同分的玩家
                        const currentScore = sortedPlayers[currentRank - 1].score;
                        const sameScorePlayers = sortedPlayers.filter(p => p.score === currentScore);
                        const count = sameScorePlayers.length;
                        
                        // 计算平均顺位分
                        let totalPositionPoints = 0;
                        for (let i = 0; i < count; i++) {
                            const posIndex = Math.min(currentRank + i - 1, positionPoints.length - 1);
                            totalPositionPoints += positionPoints[posIndex];
                        }
                        const averagePositionPoint = totalPositionPoints / count;
                        
                        // 为每个同分玩家创建结果
                        sameScorePlayers.forEach((player, i) => {
                            results.push({
                                playerId: player.id,
                                score: player.score,
                                uma: player.uma,
                                rank: currentRank + i,
                                positionPoint: averagePositionPoint,
                                totalPoint: player.uma + averagePositionPoint
                            });
                        });
                        
                        currentRank += count;
                    }
                    
                    this.currentGame.results = results;
                    this.currentGame.rankingCalculated = true;
                    this.currentGame.date = new Date();
                },
                saveGame() {
                    if (!this.currentGame.rankingCalculated) return;
                    
                    const newGame = {
                        id: Date.now(),
                        date: new Date(),
                        results: [...this.currentGame.results]
                    };
                    
                    this.historyGames.unshift(newGame);
                    this.currentGame.players = [];
                    this.currentGame.results = [];
                    this.currentGame.rankingCalculated = false;
                    
                    this.saveData();
                },
                deleteGame(gameId) {
                    if (confirm('确定要删除这个对局记录吗？')) {
                        this.historyGames = this.historyGames.filter(game => game.id !== gameId);
                        this.saveData();
                    }
                },
                selectPlayer(playerId) {
                    this.selectedPlayerId = playerId;
                },
                getPlayerName(playerId) {
                    const player = this.players.find(p => p.id === playerId);
                    return player ? player.name : '未知玩家';
                },
                formatDate(dateStr) {
                    const date = new Date(dateStr);
                    return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                },
                getPlayerStats(playerId) {
                    const playerGames = this.historyGames.filter(game => 
                        game.results.some(result => result.playerId === playerId)
                    );
                    
                    let totalGames = playerGames.length;
                    let totalUma = 0;
                    let totalPoints = 0;
                    let totalRank = 0;
                    
                    playerGames.forEach(game => {
                        const result = game.results.find(r => r.playerId === playerId);
                        if (result) {
                            totalUma += result.uma;
                            totalPoints += result.totalPoint;
                            totalRank += result.rank;
                        }
                    });
                    
                    return {
                        totalGames,
                        totalUma,
                        totalPoints,
                        averageRank: totalGames > 0 ? totalRank / totalGames : 0
                    };
                },
                getPlayerRecentGames(playerId) {
                    return this.historyGames
                        .filter(game => game.results.some(r => r.playerId === playerId))
                        .slice(0, 10);
                },
                getPlayerRankInGame(game, playerId) {
                    const result = game.results.find(r => r.playerId === playerId);
                    return result ? result.rank : '-';
                },
                getPlayerUmaInGame(game, playerId) {
                    const result = game.results.find(r => r.playerId === playerId);
                    return result ? result.uma : '-';
                },
                getPlayerPositionPointInGame(game, playerId) {
                    const result = game.results.find(r => r.playerId === playerId);
                    return result ? result.positionPoint : '-';
                },
                getPlayerTotalPointInGame(game, playerId) {
                    const result = game.results.find(r => r.playerId === playerId);
                    return result ? result.totalPoint : '-';
                }
            }
        });
    </script>
</body>
</html>